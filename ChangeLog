2006-01-18  Federico Mena Quintero  <federico@ximian.com>

	Make the standalone dialog and the property page explicit-apply
	instead of instant-apply.

	* interfaces/share-dialog.glade.in: Make the bottom separator
	invisible.  Change the button's label to "Write changes to share";
	add a Cancel button for use with the standalone dialog.  Add
	underlined mnemonics.

	* src/shares.c (add_share): Use "net usershare add -l" to have it
	print back the canonicalized info for the share.
	(add_key_group_to_hashes): Use add_share_info_to_hashes() instead
	of adding the ShareInfo by hand.

	* src/nautilus-share.c (get_share_info_for_file_info): Do not
	assert that the share_info we get back exist; there's a race
	condition in that the share could be removed between the time the
	caller learns about it and the time we query for it.
	(PropertyPage): Added fields for button_cancel and button_apply.
	(create_property_page): Load the "button_cancel" and
	"button_apply" widgets.
	(create_property_page): Do not connect to "toggled" on the check
	buttons; this won't be instant-apply.  Do not connect to "changed"
	on the comment entry.
	(on_checkbutton_share_rw_ro_toggled): #if-ed out
	(on_checkbutton_share_folder_toggled): #if-ed out
	(nautilus_share_get_property_pages): Hide the Cancel button.
	(button_callback): Removed.
	(share_this_folder_callback): Connect to the Cancel button so that
	it destroys the standalone sharing window.
	(create_property_page): Connect to button_apply.
	(button_apply_clicked_cb): New callback; just commits the property
	page.

2006-01-18  Federico Mena Quintero  <federico@ximian.com>

	* src/nautilus-share.c (NETWORK_SHARE_PREFIX): Ahem, I missed one
	slash in "network:///".
	(get_share_info_for_file_info): New function.  This is intended to
	be the master "is this NautilusFileInfo worthy of consideration" function.
	(file_get_share_status_file): Simply use
	get_share_info_for_file_info() and get_share_status_and_free_share_info().
	(nautilus_share_get_property_pages): Use
	get_share_info_for_file_info() instead of duplicating the code
	that checks for shareability.
	(nautilus_share_get_file_items): Likewise.
	(file_get_share_status): Removed.

	* src/nautilus-share.h: Removed prototype for file_get_share_status().

2006-01-18  Federico Mena Quintero  <federico@ximian.com>

	* src/nautilus-share.c (file_get_share_status_file): Match the
	file's URI against the "network://share-" prefix from gnome-vfs's
	network method, and get the info for the corresponding share name.
	(get_share_status_share_name): New helper function.
	(get_share_status_and_free_share_info): New helper function.
	(file_get_share_status): Use get_share_status_and_free_share_info().

2006-01-17  Federico Mena Quintero  <federico@ximian.com>

	* src/shares.c (refresh_shares): To list the info for all the
	shares we need "net usershare info", not "net usershare list".
	The latter only lists the share names.

	* debug-net-usershare (command): Likewise; use "info" instead of
	"list" to print the full info for all the shares.

2006-01-16  Federico Mena Quintero  <federico@ximian.com>

	* src/shares.c (net_usershare_run): Use different printf
	formats depending on whether we got an empty error string from
	"net usershare".

	* src/shares.c (DEBUG_SHARES): #undef this; the code seems to work.

	* src/shares.c (net_usershare_run): Let the ret_key_file be NULL.
	In that case, this won't attempt to parse the stdout of "net usershare".
	(add_share): Don't expect a key file from net_usershare_run().
	(modify_share): Implement in terms of remove_share() and add_share().
	(remove_share): Implement in terms of "net usershare delete".

2006-01-13  Federico Mena Quintero  <federico@ximian.com>

	* src/shares.c (net_usershare_run): Don't use G_SPAWN_FILE_AND_ARGV_ZERO.
	(refresh_shares): g_message() if net_usershare_run() fails.
	(add_share): Implement the call to net_usershare_run().
	(add_share_info_to_hashes): New helper function.
	(remove_share_info_from_hashes): New helper function.

2006-01-12  Federico Mena Quintero  <federico@ximian.com>

	* src/shares.c (shares_get_share_info_for_path): Oops, fix the
	GError assertion.
	(shares_get_share_info_for_share_name): Likewise.
	(add_key_group_to_hashes): Fix the sense of strcmp().

	* src/shares.c (DEBUG_SHARES): Add a debugging flag so that we
	call a stub program instead of "net usershare".

2006-01-12  Federico Mena Quintero  <federico@ximian.com>

	* src/shares.c (add_key_group_to_hashes): New helper function to
	get the share info out of a key file group.
	(refresh_shares): Call net_usershare_run() to get a GKeyFile out
	of "net usershare"; extract the share info groups from it.

2006-01-11  Federico Mena Quintero  <federico@ximian.com>

	* src/shares.c (refresh_shares): Return a GError.
	(refresh_if_needed): Likewise.
	(shares_get_path_is_shared): Take a GError argument; make the
	return value be a success condition.
	(shares_get_share_info_for_path): Likewise.
	(shares_get_share_name_exists): Likewise.
	(shares_get_share_info_for_share_name): Likewise.
	(shares_get_share_info_list): Likewise.
	(throw_error_on_refresh): New debugging variable.
	(shares_set_debug): Add an error_on_refresh argument.
	(refresh_shares): Throw an error if throw_error_on_refresh is set.
	(net_usershare_run): New function to run "net usershare" and parse
	its output into a GKeyFile.

	* src/nautilus-share.c (property_page_share_name_is_valid): Pass a
	GError to the shares.h functions.
	(file_get_share_status): Likewise.
	(create_property_page): Likewise.  Also, throw an error dialog if
	we can't get the sharing info.

2006-01-10  Federico Mena Quintero  <federico@ximian.com>

	* src/shares.c (refresh_if_needed): New function; refreshes the
	share list at a limited rate determined by an update counter and a
	timestamp.
	(refresh_shares): Took out of the #ifdef block along with its
	helper functions.
	(shares_get_path_is_shared): Call refresh_if_needed().
	(shares_get_share_info_for_path): Likewise.
	(shares_get_share_name_exists): Likewise.
	(shares_get_share_info_for_share_name): Likewise.
	(shares_modify_share): Likewise.
	(shares_get_share_info_list): Likewise.

2006-01-09  Federico Mena Quintero  <federico@ximian.com>

	* src/shares.[ch]: New files with small API that maintains a
	list of current shares and talks to Samba's utilities for
	modifying user shares.

	* src/nautilus-share.h: Removed the prototypes for
	nautilsu_share_get_type() and nautilus_share_register_type(); they
	are internal to nautilus-share.c now.

	* src/nautilus-share.c: Removed the d-bus includes.  Removed the
	global g_dbus.  Made all functions static except for the module
	API.  Put the unfinished share-editor stuff in an "#if 0".
	(nautilus_module_initialize): Remove the d-bus initialization
	code.  Pass NAUTILUS_SHARE_LOCALEDIR to bindtextdomain().
	(nautilus_share_get_file_items): Don't copy the file list.
	Instead, ref the fileinfo; release it when the menu item gets
	destroyed by using g_object_set_data_full().
	(get_fullpath_from_fileinfo): Assert that the fileinfo is not
	NULL.
	(PropertyPage): New PropertyPage structure, it holds all the
	fields for a property page (widgets, xml, etc.).
	(create_property_page): Create a PropertyPage and hook it to the
	appropriate widgets, so that we can keep track of them easily, and
	free their memory as appropriate.  Move all the widget fields from
	here to that structure.
	(free_property_page_cb): New callback; free the XML and other data
	when the property page's main widget is destroyed.
	(xml): Removed.  This should not be global!
	(g_sharename): Removed.  This should not be global!
	(create_property_page): Use g_filename_display_basename() to get
	the fallback name from the path; g_path_get_basename() would give
	us a string potentially not in UTF-8 encoding.
	(create_property_page): Pass the PropertyPage to the callbacks,
	instead of special-casing each one for strings or a file info.
	Connect to "changed" on the text entries, not "focus-out-event".
	(create_property_page): Connect the signal handlers *after*
	setting the initial widget states so that they don't interfere
	with the settings.
	(create_property_page): Don't set the ->active field in toggle
	buttons directly!  Call gtk_toggle_button_set_active().
	(create_property_page): Compute the string length from the entry
	with g_utf8_strlen(); not plain strlen().
	(commit_property_page): New function; take a PropertyPage and
	commit its properties to the shares_*() functions.
	(on_checkbutton_share_rw_ro_toggled): Use commit_property_page().
	(left_share_name_text_entry): Fix the prototype; this was taking
	the wrong event type.  Now it gets passed a PropertyPage in the
	user_data.  Use commit_property_page().
	(property_page_set_sensitivity): New helper function.
	(on_checkbutton_share_folder_toggled): Use
	property_page_set_sensitivity().  Use property_page_commit().
	(property_page_set_error): Renamed from set_error().  Take a
	PropertyPage rather than a widget.  Take an error message; we'll
	get this in the GError from the backend.
	(property_page_set_warning): Renamed from set_warning().  Take a
	PropertyPage rather than a widget.
	(property_page_set_normal): Renamed form set_normal().  Take a
	PropertyPage rather than a widget.
	(validate_fields): New helper function.
	(create_property_page): Connect to "changed" on the name entry
	instead of "key-release-event".
	(property_page_share_name_is_valid): New helper function.
	(modify_share_name_text_entry): Use property_page_share_name_is_valid().
	(left_share_name_text_entry): Likewise.
	(modify_share_name_text_entry): New callback.
	(file_get_share_status): Use the shares functions instead of the
	d-bus backend.
	(file_get_share_status_file): Remove redundant tests.

	* src/Makefile.am (libnautilus_share_la_CFLAGS): Don't define GNOMELOCALEDIR.

	* configure.in: Add "AM_GLIB_DEFINE_LOCALEDIR(NAUTILUS_SHARE_LOCALEDIR)".

	* ChangeLog: Start the ChangeLog.
